package edu.harvard.we99.domain.results;

import edu.harvard.we99.domain.BaseEntity;
import edu.harvard.we99.domain.Coordinate;
import edu.harvard.we99.domain.Experiment;
import edu.harvard.we99.domain.Plate;
import edu.harvard.we99.jaxb.DateTimeAdapter;
import edu.harvard.we99.jaxb.WellResultAdapter;
import org.hibernate.annotations.Type;
import org.joda.time.DateTime;

import javax.annotation.Generated;
import javax.persistence.CascadeType;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.ManyToOne;
import javax.persistence.MapKey;
import javax.persistence.OneToMany;
import javax.persistence.PreUpdate;
import javax.validation.constraints.NotNull;
import javax.xml.bind.annotation.XmlTransient;
import javax.xml.bind.annotation.adapters.XmlJavaTypeAdapter;
import java.util.HashMap;
import java.util.Map;

/**
 * Result of the plate's analysis from a device.
 *
 * @author mford
 */
@Entity
public class PlateResult extends BaseEntity {
    /**
     * Primary key field is auto generated
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * Creation time
     */
    @Type(type="org.jadira.usertype.dateandtime.joda.PersistentDateTime")
    @XmlJavaTypeAdapter(DateTimeAdapter.class)
    private DateTime created;

    /**
     * Time of the last modification (computed when the bean is saved)
     */
    @Type(type="org.jadira.usertype.dateandtime.joda.PersistentDateTime")
    @XmlJavaTypeAdapter(DateTimeAdapter.class)
    private DateTime lastModified;

    /**
     * Optional comments from the user about this plate or its changes
     */
    private String comments;

    /**
     * Parent experiement that this result belongs to
     */
    @ManyToOne
    @XmlTransient
    private Experiment experiment;

    /**
     * Reference to the plate that these results belong to
     */
    @ManyToOne(fetch = FetchType.LAZY)
    @XmlTransient
    @NotNull
    private Plate plate;

    /**
     * The results by coordinate.
     */
    @OneToMany(cascade = CascadeType.PERSIST)
    @MapKey(name="coordinate")
    @XmlJavaTypeAdapter(WellResultAdapter.class)
    private Map<Coordinate,WellResults> wellResults = new HashMap<>();

    @PreUpdate
    private void preUpdate() {
        this.lastModified = new DateTime();
    }

    @Generated(value = "generated by IDE")
    public Experiment getExperiment() {
        return experiment;
    }

    @Generated(value = "generated by IDE")
    public void setExperiment(Experiment experiment) {
        this.experiment = experiment;
    }

    @Generated(value = "generated by IDE")
    public Long getId() {
        return id;
    }

    @Override
    @Generated(value = "generated by IDE")
    public void setId(Long id) {
        this.id = id;
    }

    @Generated(value = "generated by IDE")
    public Plate getPlate() {
        return plate;
    }

    @Generated(value = "generated by IDE")
    public void setPlate(Plate plate) {
        this.plate = plate;
    }

    @Generated(value = "generated by IDE")
    public Map<Coordinate, WellResults> getWellResults() {
        return wellResults;
    }

    @Generated(value = "generated by IDE")
    public void setWellResults(Map<Coordinate, WellResults> wellResults) {
        this.wellResults = wellResults;
    }

    @Generated(value = "generated by IDE")
    public String getComments() {
        return comments;
    }

    @Generated(value = "generated by IDE")
    public void setComments(String comments) {
        this.comments = comments;
    }

    @Generated(value = "generated by IDE")
    public DateTime getCreated() {
        return created;
    }

    @Generated(value = "generated by IDE")
    public void setCreated(DateTime created) {
        this.created = created;
    }

    @Generated(value = "generated by IDE")
    public DateTime getLastModified() {
        return lastModified;
    }
}
